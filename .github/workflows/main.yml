name: macOS Sequoia Tailscale VNC (Manual Fix)
on: workflow_dispatch

jobs:
  macos-vnc:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Tailscale Manuel Kurulum (macOS için)
        env:
          TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          # Tailscale'i brew ile kuruyoruz
          brew install tailscale
          # Tailscale servisini arka planda başlat
          sudo tailscaled > /dev/null 2>&1 &
          sleep 5
          # Login ol ve ağına bağlan
          sudo tailscale up --authkey=$TS_AUTHKEY --accept-routes

      - name: Kullanıcı Şifresini ve Otomatik Girişi Ayarla
        run: |
          USER_NAME=$(whoami)
          NEW_PASS="Ed4kaleen2024!"
          sudo dscl . -passwd /Users/$USER_NAME "$NEW_PASS"
          sudo defaults write /Library/Preferences/com.apple.loginwindow autoLoginUser -string "$USER_NAME"
          # Sequoia için ekran kilidini esnetme
          sudo sysadminctl -adminUser "$USER_NAME" -adminPassword "$NEW_PASS" -screenLock off || true
          echo "Şifre ve giriş ayarlandı!"

      - name: VNC ve Ekran Paylaşımını Başlat
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -access -on -restart -agent -privs -all -allowAccessFor -allUsers
          echo "VNC Aktif!"

      - name: IP Bilgisi ve Bekleme
        run: |
          echo "Tailscale IP'niz:"
          tailscale ip -4
          echo "Kullanıcı: runner"
          echo "Şifre: Ed4kaleen2024!"
          # 6 saat açık tut
          sleep 21600
          
