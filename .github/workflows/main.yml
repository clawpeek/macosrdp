name: macOS Sequoia VNC (Fixed Login)
on: workflow_dispatch

jobs:
  macos-vnc:
    runs-on: macos-15 # ARM tabanlı Sequoia
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Tailscale Kur ve Bağlan
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Kullanıcı Şifresini ve Otomatik Girişi Ayarla
        run: |
          # Kullanıcı adını belirle
          USER_NAME=$(whoami)
          NEW_PASS="Ed4kaleen2024!"

          # 1. Sistem kullanıcısının şifresini senin istediğin şifre yapıyoruz
          sudo dscl . -passwd /Users/$USER_NAME "$NEW_PASS"
          
          # 2. Otomatik girişi (Auto-Login) aktif et
          sudo defaults write /Library/Preferences/com.apple.loginwindow autoLoginUser -string "$USER_NAME"
          
          # 3. Ekran kilidini ve şifre sorma ekranını devre dışı bırak
          sysadminctl -adminUser "$USER_NAME" -adminPassword "$NEW_PASS" -screenLock off
          
          echo "Kullanıcı: $USER_NAME"
          echo "Şifre ayarlandı, kilitler açıldı devrem!"

      - name: VNC ve Ekran Paylaşımını Ateşle
        run: |
          # VNC erişimi için gereken izinleri ver
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -access -on -restart -agent -privs -all -allowAccessFor -allUsers
          
          # VNC şifresini sistem şifresiyle aynı yapalım (İhtiyat tedbiri)
          sudo /usr/libexec/PlistBuddy -c "Set :TargetSharedDisplayMode 1" /Library/Preferences/com.apple.RemoteManagement.plist
          
          echo "VNC Servisi Hazır!"

      - name: Bağlantı Bilgilerini Yazdır
        run: |
          echo "---------------------------------------------------"
          echo "BAĞLANTI BİLGİLERİ"
          echo "IP Adresi (Tailscale): $(tailscale ip -4)"
          echo "Kullanıcı Adı: $(whoami)"
          echo "Şifre: Ed4kaleen2024!"
          echo "---------------------------------------------------"

      - name: Sistemi Ayakta Tut (6 Saat)
        run: sleep 21600
        
